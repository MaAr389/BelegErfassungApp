@page "/admin/users"
@rendermode InteractiveServer
@using BelegErfassungApp.Data
@using BelegErfassungApp.Services
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Administrator")]

@inject IUserManagementService UserService
@inject NavigationManager Navigation

<PageTitle>Benutzerverwaltung</PageTitle>

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col">
            <h3>Benutzerverwaltung</h3>
        </div>
        <div class="col-auto">
            <button class="btn btn-primary" @onclick="ShowCreateUserDialog">
                <span class="bi bi-person-plus-fill"></span> Neuen Benutzer anlegen
            </button>
        </div>
    </div>

    @if (users == null)
    {
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Laden...</span>
            </div>
        </div>
    }
    else if (!users.Any())
    {
        <div class="alert alert-info">Keine Benutzer vorhanden.</div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Benutzername</th>
                        <th>E-Mail</th>
                        <th>Rolle</th>
                        <th style="width: 200px;">Aktionen</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var user in users)
                    {
                        <tr>
                            <td>@user.Username</td>
                            <td>@user.Email</td>
                            <td>
                                <select class="form-select form-select-sm"
                                        value="@user.Roles.FirstOrDefault()"
                                        @onchange="e => UpdateRole(user.Id, e.Value?.ToString() ?? string.Empty)"
                                        disabled="@isProcessing">
                                    @foreach (var role in availableRoles)
                                    {
                                        <option value="@role">@role</option>
                                    }
                                </select>
                            </td>
                            <td>
                                <button class="btn btn-warning btn-sm me-1"
                                        @onclick="() => ShowEditUserDialog(user)"
                                        disabled="@isProcessing">
                                    <span class="bi bi-pencil"></span> Bearbeiten
                                </button>
                                <button class="btn btn-danger btn-sm"
                                        @onclick="() => ConfirmDelete(user)"
                                        disabled="@isProcessing">
                                    <span class="bi bi-trash"></span> Löschen
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@* Create User Modal *@
@if (showCreateDialog)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Neuen Benutzer anlegen</h5>
                    <button type="button" class="btn-close" @onclick="CloseCreateDialog" disabled="@isProcessing"></button>
                </div>
                <div class="modal-body">
                    <EditForm Model="@newUser" OnValidSubmit="CreateUser">
                        <DataAnnotationsValidator />

                        <div class="mb-3">
                            <label class="form-label">E-Mail *</label>
                            <InputText @bind-Value="newUser.Email" class="form-control" />
                            <ValidationMessage For="@(() => newUser.Email)" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Benutzername *</label>
                            <InputText @bind-Value="newUser.Username" class="form-control" />
                            <ValidationMessage For="@(() => newUser.Username)" />
                            <small class="text-muted">Muss identisch mit E-Mail sein für den Login</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Passwort *</label>
                            <InputText @bind-Value="newUser.Password" type="password" class="form-control" />
                            <ValidationMessage For="@(() => newUser.Password)" />
                            <small class="text-muted">Mindestens 8 Zeichen, Groß-/Kleinbuchstaben, Zahl und Sonderzeichen</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Rolle *</label>
                            <InputSelect @bind-Value="newUser.Role" class="form-select">
                                @foreach (var role in availableRoles)
                                {
                                    <option value="@role">@role</option>
                                }
                            </InputSelect>
                            <ValidationMessage For="@(() => newUser.Role)" />
                        </div>

                        @if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <div class="alert alert-danger">@errorMessage</div>
                        }

                        @if (!string.IsNullOrEmpty(successMessage))
                        {
                            <div class="alert alert-success">@successMessage</div>
                        }

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @onclick="CloseCreateDialog" disabled="@isProcessing">
                                Abbrechen
                            </button>
                            <button type="submit" class="btn btn-primary" disabled="@isProcessing">
                                @if (isProcessing)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                }
                                Erstellen
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

@* Edit User Modal *@
@if (showEditDialog && editUser != null)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Benutzer bearbeiten</h5>
                    <button type="button" class="btn-close" @onclick="CloseEditDialog" disabled="@isProcessing"></button>
                </div>
                <div class="modal-body">
                    <EditForm Model="@editUser" OnValidSubmit="UpdateUser">
                        <DataAnnotationsValidator />

                        <div class="mb-3">
                            <label class="form-label">E-Mail *</label>
                            <InputText @bind-Value="editUser.Email" class="form-control" />
                            <ValidationMessage For="@(() => editUser.Email)" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Benutzername *</label>
                            <InputText @bind-Value="editUser.Username" class="form-control" />
                            <ValidationMessage For="@(() => editUser.Username)" />
                            <small class="text-muted">Muss identisch mit E-Mail sein für den Login</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Neues Passwort (optional)</label>
                            <InputText @bind-Value="editUser.NewPassword" type="password" class="form-control" />
                            <small class="text-muted">Leer lassen, um Passwort nicht zu ändern</small>
                        </div>

                        @if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <div class="alert alert-danger">@errorMessage</div>
                        }

                        @if (!string.IsNullOrEmpty(successMessage))
                        {
                            <div class="alert alert-success">@successMessage</div>
                        }

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @onclick="CloseEditDialog" disabled="@isProcessing">
                                Abbrechen
                            </button>
                            <button type="submit" class="btn btn-primary" disabled="@isProcessing">
                                @if (isProcessing)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                }
                                Speichern
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

@* Delete Confirmation Modal *@
@if (showDeleteDialog && userToDelete != null)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Benutzer löschen</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CloseDeleteDialog" disabled="@isProcessing"></button>
                </div>
                <div class="modal-body">
                    <p>Möchten Sie den Benutzer <strong>@userToDelete.Username</strong> wirklich löschen?</p>
                    <p class="text-danger"><strong>Diese Aktion kann nicht rückgängig gemacht werden!</strong></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseDeleteDialog" disabled="@isProcessing">
                        Abbrechen
                    </button>
                    <button type="button" class="btn btn-danger" @onclick="DeleteUser" disabled="@isProcessing">
                        @if (isProcessing)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                        }
                        Löschen
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<UserDto>? users;
    private List<string> availableRoles = new();
    private bool showCreateDialog = false;
    private bool showEditDialog = false;
    private bool showDeleteDialog = false;
    private bool isProcessing = false;
    private UserDto? userToDelete;
    private NewUserModel newUser = new();
    private EditUserModel? editUser;
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        users = await UserService.GetAllUsersAsync();
        availableRoles = await UserService.GetAllRolesAsync();
    }

    private void ShowCreateUserDialog()
    {
        newUser = new NewUserModel { Role = "Mitglied" };
        errorMessage = string.Empty;
        successMessage = string.Empty;
        showCreateDialog = true;
    }

    private void CloseCreateDialog()
    {
        showCreateDialog = false;
        newUser = new();
        errorMessage = string.Empty;
        successMessage = string.Empty;
    }

    private async Task CreateUser()
    {
        isProcessing = true;
        errorMessage = string.Empty;
        successMessage = string.Empty;

        try
        {
            var result = await UserService.CreateUserAsync(
                newUser.Email,
                newUser.Username,
                newUser.Password,
                newUser.Role
            );

            if (result.Succeeded)
            {
                successMessage = $"Benutzer {newUser.Username} wurde erfolgreich erstellt.";
                await LoadData();

                await Task.Delay(1500);
                CloseCreateDialog();
            }
            else
            {
                errorMessage = string.Join(", ", result.Errors.Select(e => e.Description));
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Fehler beim Erstellen des Benutzers: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
        }
    }

    private void ShowEditUserDialog(UserDto user)
    {
        editUser = new EditUserModel
        {
            Id = user.Id,
            Email = user.Email,
            Username = user.Username,
            NewPassword = string.Empty
        };
        errorMessage = string.Empty;
        successMessage = string.Empty;
        showEditDialog = true;
    }

    private void CloseEditDialog()
    {
        showEditDialog = false;
        editUser = null;
        errorMessage = string.Empty;
        successMessage = string.Empty;
    }

    private async Task UpdateUser()
    {
        if (editUser == null) return;

        isProcessing = true;
        errorMessage = string.Empty;
        successMessage = string.Empty;

        try
        {
            // Update Benutzerdaten
            var result = await UserService.UpdateUserAsync(
                editUser.Id,
                editUser.Email,
                editUser.Username
            );

            if (!result.Succeeded)
            {
                errorMessage = string.Join(", ", result.Errors.Select(e => e.Description));
                return;
            }

            // Passwort ändern, falls angegeben
            if (!string.IsNullOrWhiteSpace(editUser.NewPassword))
            {
                var passwordResult = await UserService.ResetPasswordAsync(editUser.Id, editUser.NewPassword);
                if (!passwordResult.Succeeded)
                {
                    errorMessage = "Benutzer aktualisiert, aber Passwort-Änderung fehlgeschlagen: " +
                                 string.Join(", ", passwordResult.Errors.Select(e => e.Description));
                    return;
                }
            }

            successMessage = $"Benutzer {editUser.Username} wurde erfolgreich aktualisiert.";
            await LoadData();

            await Task.Delay(1500);
            CloseEditDialog();
        }
        catch (Exception ex)
        {
            errorMessage = $"Fehler beim Aktualisieren: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task UpdateRole(string userId, string newRole)
    {
        if (string.IsNullOrEmpty(newRole)) return;

        isProcessing = true;
        try
        {
            var result = await UserService.UpdateUserRoleAsync(userId, newRole);
            if (!result.Succeeded)
            {
                errorMessage = string.Join(", ", result.Errors.Select(e => e.Description));
            }
            await LoadData();
        }
        finally
        {
            isProcessing = false;
        }
    }

    private void ConfirmDelete(UserDto user)
    {
        userToDelete = user;
        showDeleteDialog = true;
    }

    private void CloseDeleteDialog()
    {
        showDeleteDialog = false;
        userToDelete = null;
    }

    private async Task DeleteUser()
    {
        if (userToDelete == null) return;

        isProcessing = true;
        try
        {
            var result = await UserService.DeleteUserAsync(userToDelete.Id);
            if (result.Succeeded)
            {
                await LoadData();
                CloseDeleteDialog();
            }
            else
            {
                errorMessage = string.Join(", ", result.Errors.Select(e => e.Description));
            }
        }
        finally
        {
            isProcessing = false;
        }
    }

    public class NewUserModel
    {
        public string Email { get; set; } = string.Empty;
        public string Username { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
        public string Role { get; set; } = "Mitglied";
    }

    public class EditUserModel
    {
        public string Id { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string Username { get; set; } = string.Empty;
        public string NewPassword { get; set; } = string.Empty;
    }
}
